# Next Steps Action Plan — 2025-08-10 14:36

This document translates the 2025-08-09 assessment into concrete, trackable next steps. Scope focuses on production reliability, observability, security, and CI readiness for the V2 engines completion track.

Branch context: feature/ops-observability-ci-20250810

## Summary of Gaps (from Findings)
- Observability: Prometheus text endpoints exist; no OpenTelemetry or Grafana wiring.
- Health/Ready/Warmup: Implemented across agents but schemas are not centralized.
- MCP Bus Resilience: Retries/backoff/circuit breaker present; no idempotency keys.
- GPU Ops: No shared gpu_utils or mixed precision toggles across agents.
- CI/Supply chain: CI workflow present but empty; no scans or tests wired.
- Caching/Dedup: Memory has content hashing; no MCP-level dedup/fingerprints.
- Security: No inter-service auth or rate limiting.
- Vector store: pgvector/indexes/retention not confirmed or codified.

---

## P0 — Reliability & Safety (next 24–48h)
- MCP idempotency keys for /call
  - Implement optional X-Idempotency-Key in MCP Bus; deduplicate identical in-flight or recently completed calls per (agent, tool, key).
  - Log key usage; expose counters in /metrics.
  - Add unit tests for duplicate suppression and expiry.

- Observability baseline everywhere
  - Keep existing Prometheus text metrics; add latency histograms p50/p95/p99 to common/observability.
  - Add request/error counters and circuit-breaker state metrics to MCP Bus.
  - Document Grafana dashboard wiring (scrape targets, sample dashboard JSON) under markdown_docs/.

- Standardize schemas and endpoints
  - Create common/schemas.py with versioned ToolCall (v1) + minimal Health/Ready/Warmup response models.
  - Update all agents and MCP Bus imports to use common schemas.
  - Add contract tests to validate schemas and endpoint presence.

- Startup readiness & warmup consistency
  - Ensure warmup preloads light-weight assets and optional GPU paths without heavy downloads.
  - Add /warmup success counters to all agents’ /metrics.

---

## P1 — Performance & Scalability (this week)
- Shared gpu_utils and mixed precision toggles
  - Add common/gpu_utils.py: safe_gpu_operation(ctx), memory logging (allocated/reserved), autocast controls, cleanup helpers.
  - Integrate into Analyst, Synthesizer, Critic, Memory; log leak deltas on exit.

- MCP request deduplication (payload fingerprint)
  - Hash payload (agent, tool, SHA256(args+kwargs canonical JSON)); short TTL cache to drop duplicates.
  - Expose dedup_hits metric; add targeted tests.

- CI pipeline (GitHub Actions)
  - Lint/typecheck: ruff/flake8 + mypy; unit tests for MCP Bus and common libs.
  - Security scans: pip-audit/safety; optional Trivy on images (kept minimal even though Docker runtime is deprecated).
  - Artifacts: Prometheus metrics snapshot and coverage reports.

- Vector store readiness
  - Add migration/task to enable pgvector; create indexes and connection pooling defaults.
  - Document retention policy and connection pool sizing; add db health alerting guidance.

---

## P1 — Security & Compliance (this week)
- Inter-service auth (phase 1: token)
  - Require signed bearer token between MCP Bus and agents; configurable via env; reject missing/invalid.
  - Optional mTLS evaluation logged as follow-up.

- Rate limiting (simple middleware)
  - Per-agent basic rate limits for high-risk endpoints (e.g., heavy GPU calls).
  - Counters and over-limit logs exposed in /metrics.

- Secrets handling
  - Ensure sensitive values via environment/systemd; scrub from logs; add docs.

---

## Documentation & Runbooks
- Add agent runbooks to markdown_docs/agent_documentation/ (failure modes, SLOs, playbooks).
- Add Grafana/Prometheus wiring guide and sample dashboards under markdown_docs/development_reports/.
- Update CHANGELOG.md once the above land with performance/observability metrics.

---

## Acceptance Criteria
- All agents and MCP Bus expose: /health, /ready, /warmup, /metrics (with request histograms).
- MCP Bus supports idempotency keys and dedup TTL with tests.
- Common schemas (ToolCall v1) adopted across services; contract tests green.
- CI runs lint/typecheck/tests and security scans; status checks required on PRs.
- gpu_utils present and used by at least 3 agents; mixed precision toggle documented.
- Basic token-based auth enforced on MCP Bus <-> agents; rate limit counters visible.
- Vector store readiness documented; migration script or init path available.

---

## Task Breakdown (trackable)
- [ ] MCP Bus: idempotency keys + dedup TTL + metrics + tests
- [ ] common/observability: latency histograms p50/p95/p99
- [ ] MCP Bus: expose circuit breaker metrics; integrate observability
- [ ] common/schemas.py: ToolCall v1 + health models; agents & Bus refactor
- [ ] Contract tests: schemas/endpoints presence
- [ ] common/gpu_utils.py: safe ops, autocast, memory logging
- [ ] Integrate gpu_utils into Analyst/Synthesizer/Critic/Memory
- [ ] CI workflow: lint/mypy/pytest + pip-audit/safety; required checks
- [ ] Security: bearer token between Bus and agents; rate limiting in Bus
- [ ] Vector store: pgvector enablement + indexing doc/migration
- [ ] Docs: runbooks, Grafana wiring, CHANGELOG update with metrics

---

## Risks & Notes
- OpenTelemetry full tracing is deferred; Prometheus text + Grafana first for speed.
- Docker runtime is deprecated; keep minimal Trivy optional scan for image-based paths.
- Ensure zero-crash and minimal overhead when adding middleware and metrics.

---

Requirements coverage: This plan is derived from the latest findings (2025-08-10) and maps each identified gap to an actionable item with acceptance criteria and tracking checkboxes.
